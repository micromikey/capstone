# ğŸ« Slot Reservation Flow Diagram

## Complete User Journey with Slot Management

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SLOT RESERVATION SYSTEM                          â”‚
â”‚                                                                          â”‚
â”‚  Example: Mt. Pulag Trail - Batch on Oct 15, 2025                      â”‚
â”‚  Initial State: 50 capacity, 20 slots taken, 30 available              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: User Browses Trail                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  User views: Mt. Pulag Trail Page                                       â”‚
â”‚  â”œâ”€ Sees available batches/dates                                        â”‚
â”‚  â”œâ”€ Clicks "Book This Trail" button                                     â”‚
â”‚  â””â”€ Opens booking form                                                  â”‚
â”‚                                                                          â”‚
â”‚  ğŸ¯ Batch Info Display:                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚ Oct 15, 2025 - 6:00 AM             â”‚                                 â”‚
â”‚  â”‚                                     â”‚                                 â”‚
â”‚  â”‚ ğŸ“Š 30 slots available               â”‚                                 â”‚
â”‚  â”‚ â–“â–“â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 40% full           â”‚                                 â”‚
â”‚  â”‚                                     â”‚                                 â”‚
â”‚  â”‚ [Select This Date]                  â”‚                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: Fill Booking Form                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  ğŸ“ Booking Form:                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚ Trail: Mt. Pulag                   â”‚                                 â”‚
â”‚  â”‚ Date: Oct 15, 2025                 â”‚                                 â”‚
â”‚  â”‚ Party Size: [10] people            â”‚ â—„â”€â”€ User enters 10              â”‚
â”‚  â”‚                                     â”‚                                 â”‚
â”‚  â”‚ âœ… 30 slots available               â”‚                                 â”‚
â”‚  â”‚                                     â”‚                                 â”‚
â”‚  â”‚ [Continue to Payment]               â”‚                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                                                          â”‚
â”‚  âš¡ Real-time Validation (AJAX):                                        â”‚
â”‚     GET /api/slots/batch/1?party_size=10                                â”‚
â”‚     Response: { "has_enough_slots": true, "available_slots": 30 }       â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: Slot Validation in BookingController                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  ğŸ”’ Database Transaction Begins                                         â”‚
â”‚  â”œâ”€ Lock batch row: lockForUpdate()                                     â”‚
â”‚  â”œâ”€ Check: hasAvailableSlots(10) â†’ TRUE âœ…                              â”‚
â”‚  â”œâ”€ Create booking with status = 'pending'                              â”‚
â”‚  â””â”€ Commit transaction                                                  â”‚
â”‚                                                                          â”‚
â”‚  ğŸ“Š Batch State (UNCHANGED):                                            â”‚
â”‚  â”œâ”€ Capacity: 50                                                        â”‚
â”‚  â”œâ”€ Slots Taken: 20  â—„â”€â”€ No change yet!                                â”‚
â”‚  â””â”€ Available: 30                                                       â”‚
â”‚                                                                          â”‚
â”‚  ğŸ’¡ Why not reserve now?                                                â”‚
â”‚     â†’ Prevents holding slots for unpaid bookings                        â”‚
â”‚     â†’ User might abandon payment                                        â”‚
â”‚     â†’ Slots reserved only after payment confirmation                    â”‚
â”‚                                                                          â”‚
â”‚  ğŸ« Booking Created:                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚ Booking #123                       â”‚                                 â”‚
â”‚  â”‚ â”œâ”€ User: John Doe                  â”‚                                 â”‚
â”‚  â”‚ â”œâ”€ Trail: Mt. Pulag                â”‚                                 â”‚
â”‚  â”‚ â”œâ”€ Party Size: 10                  â”‚                                 â”‚
â”‚  â”‚ â”œâ”€ Status: pending â³               â”‚                                 â”‚
â”‚  â”‚ â””â”€ Amount: â‚±5,000                  â”‚                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                                                          â”‚
â”‚  â†’ Redirect to: /payment/create?booking_id=123                          â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 4: Payment Form                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  ğŸ’³ Payment Form (Pre-filled from Booking):                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚ ğŸ“‹ Booking #123                    â”‚                                 â”‚
â”‚  â”‚                                     â”‚                                 â”‚
â”‚  â”‚ Full Name: John Doe                â”‚ (readonly)                      â”‚
â”‚  â”‚ Email: john@example.com            â”‚ (readonly)                      â”‚
â”‚  â”‚ Mountain: Mt. Pulag                â”‚ (readonly)                      â”‚
â”‚  â”‚ Hike Date: Oct 15, 2025            â”‚ (readonly)                      â”‚
â”‚  â”‚ Participants: 10                   â”‚ (readonly)                      â”‚
â”‚  â”‚                                     â”‚                                 â”‚
â”‚  â”‚ Amount: â‚±5,000                     â”‚ (readonly)                      â”‚
â”‚  â”‚ Note: â‚±500 per person Ã— 10         â”‚                                 â”‚
â”‚  â”‚                                     â”‚                                 â”‚
â”‚  â”‚ Phone: [___________]                â”‚ (user fills)                    â”‚
â”‚  â”‚                                     â”‚                                 â”‚
â”‚  â”‚ [Pay with PayMongo]                 â”‚                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 5: PayMongo Payment Processing                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  User clicks "Pay with PayMongo"                                        â”‚
â”‚  â”œâ”€ PaymentController::processPayment()                                 â”‚
â”‚  â”œâ”€ Creates BookingPayment record:                                      â”‚
â”‚  â”‚   â”œâ”€ booking_id: 123                                                 â”‚
â”‚  â”‚   â”œâ”€ amount: 500000 (â‚±5,000 in cents)                               â”‚
â”‚  â”‚   â””â”€ payment_status: pending                                         â”‚
â”‚  â”‚                                                                       â”‚
â”‚  â”œâ”€ Calls PayMongo API                                                  â”‚
â”‚  â””â”€ Redirects user to PayMongo checkout page                            â”‚
â”‚                                                                          â”‚
â”‚  ğŸ“Š Batch State (STILL UNCHANGED):                                      â”‚
â”‚  â”œâ”€ Capacity: 50                                                        â”‚
â”‚  â”œâ”€ Slots Taken: 20  â—„â”€â”€ Still no change!                              â”‚
â”‚  â””â”€ Available: 30                                                       â”‚
â”‚                                                                          â”‚
â”‚  User completes payment on PayMongo...                                  â”‚
â”‚  â”œâ”€ Enters card: 4120 0000 0000 0007                                    â”‚
â”‚  â””â”€ Confirms payment âœ…                                                 â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 6: PayMongo Webhook (SLOT RESERVATION HAPPENS HERE!)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  ğŸ“¡ PayMongo sends webhook:                                             â”‚
â”‚     POST /payment/webhook                                               â”‚
â”‚     {                                                                   â”‚
â”‚       "data": {                                                         â”‚
â”‚         "type": "link.payment.paid",                                    â”‚
â”‚         "reference_number": "PAYMENT-123"                               â”‚
â”‚       }                                                                 â”‚
â”‚     }                                                                   â”‚
â”‚                                                                          â”‚
â”‚  âš™ï¸  PaymentController::webhook()                                       â”‚
â”‚  â”œâ”€ Find payment #123                                                   â”‚
â”‚  â”œâ”€ Load booking with batch                                             â”‚
â”‚  â”œâ”€ Mark payment as 'paid'                                              â”‚
â”‚  â”œâ”€ Update booking status: 'confirmed'                                  â”‚
â”‚  â””â”€ âœ¨ RESERVE SLOTS:                                                   â”‚
â”‚      $batch->reserveSlots(10);                                          â”‚
â”‚                                                                          â”‚
â”‚  ğŸ”¥ Batch State UPDATED:                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚ Capacity: 50                       â”‚                                 â”‚
â”‚  â”‚ Slots Taken: 30 â—„â”€â”€ +10 RESERVED!  â”‚                                 â”‚
â”‚  â”‚ Available: 20                      â”‚                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                                                          â”‚
â”‚  ğŸ« Booking #123 CONFIRMED:                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚ Booking #123                       â”‚                                 â”‚
â”‚  â”‚ â”œâ”€ Status: confirmed âœ…             â”‚                                 â”‚
â”‚  â”‚ â”œâ”€ Payment: paid âœ…                 â”‚                                 â”‚
â”‚  â”‚ â””â”€ Slots: 10 RESERVED âœ…            â”‚                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                                                          â”‚
â”‚  ğŸ“ Logged:                                                              â”‚
â”‚     "Slots Reserved Successfully"                                       â”‚
â”‚     - booking_id: 123                                                   â”‚
â”‚     - party_size: 10                                                    â”‚
â”‚     - slots_remaining: 20                                               â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 7: Success Page                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  User redirected to: /payment/success?payment_id=123                    â”‚
â”‚                                                                          â”‚
â”‚  ğŸ‰ Success Page Display:                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚ âœ… Payment Successful!              â”‚                                 â”‚
â”‚  â”‚                                     â”‚                                 â”‚
â”‚  â”‚ Booking #123                       â”‚                                 â”‚
â”‚  â”‚ Payment ID: PAY-123456              â”‚                                 â”‚
â”‚  â”‚                                     â”‚                                 â”‚
â”‚  â”‚ Trail: Mt. Pulag                   â”‚                                 â”‚
â”‚  â”‚ Date: Oct 15, 2025                 â”‚                                 â”‚
â”‚  â”‚ Participants: 10                   â”‚                                 â”‚
â”‚  â”‚ Amount Paid: â‚±5,000.00             â”‚                                 â”‚
â”‚  â”‚                                     â”‚                                 â”‚
â”‚  â”‚ Status: âœ… Confirmed                â”‚                                 â”‚
â”‚  â”‚                                     â”‚                                 â”‚
â”‚  â”‚ Your 10 slots are now RESERVED!    â”‚                                 â”‚
â”‚  â”‚                                     â”‚                                 â”‚
â”‚  â”‚ [View Booking Details]              â”‚                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IMPACT: Other Users Now See Updated Availability                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  ğŸŒ Public Trail Page Now Shows:                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚ Oct 15, 2025 - 6:00 AM             â”‚                                 â”‚
â”‚  â”‚                                     â”‚                                 â”‚
â”‚  â”‚ âš ï¸  20 slots available              â”‚ â—„â”€â”€ Updated!                   â”‚
â”‚  â”‚ â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘ 60% full           â”‚ â—„â”€â”€ 30/50 reserved             â”‚
â”‚  â”‚                                     â”‚                                 â”‚
â”‚  â”‚ [Select This Date]                  â”‚                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                                                          â”‚
â”‚  If another user tries to book 25 people:                               â”‚
â”‚  âŒ "Only 20 slot(s) available. You requested 25."                      â”‚
â”‚  ğŸ’¡ "Try these dates: Oct 20, Oct 25, Nov 1"                            â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ALTERNATIVE FLOW: Booking Cancellation                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  User wants to cancel Booking #123                                      â”‚
â”‚                                                                          â”‚
â”‚  ğŸ” Check if cancellable:                                               â”‚
â”‚  $booking->canBeCancelled()                                             â”‚
â”‚  â”œâ”€ Status not 'cancelled' âœ…                                           â”‚
â”‚  â””â”€ Batch hasn't started yet âœ…                                         â”‚
â”‚                                                                          â”‚
â”‚  âœ… Cancellation Allowed                                                â”‚
â”‚                                                                          â”‚
â”‚  âš™ï¸  Execute:                                                            â”‚
â”‚  $booking->cancel();                                                    â”‚
â”‚                                                                          â”‚
â”‚  What happens:                                                          â”‚
â”‚  â”œâ”€ Update booking status: 'cancelled'                                  â”‚
â”‚  â””â”€ Release slots: $batch->releaseSlots(10)                             â”‚
â”‚                                                                          â”‚
â”‚  ğŸ”¥ Batch State UPDATED:                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚ Capacity: 50                       â”‚                                 â”‚
â”‚  â”‚ Slots Taken: 20 â—„â”€â”€ -10 RELEASED!  â”‚                                 â”‚
â”‚  â”‚ Available: 30                      â”‚                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                                                          â”‚
â”‚  Result:                                                                â”‚
â”‚  â”œâ”€ User's 10 slots released                                            â”‚
â”‚  â”œâ”€ Availability increased to 30                                        â”‚
â”‚  â””â”€ Other users can now book those slots                                â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EDGE CASE: Race Condition Prevention                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  Scenario: Two users try to book the LAST 5 slots simultaneously        â”‚
â”‚                                                                          â”‚
â”‚  Time: 10:00:00.000                                                     â”‚
â”‚  â”œâ”€ Batch: 50 capacity, 45 slots taken, 5 available                     â”‚
â”‚  â”œâ”€ User A: Wants to book 5 people                                      â”‚
â”‚  â””â”€ User B: Wants to book 5 people                                      â”‚
â”‚                                                                          â”‚
â”‚  Time: 10:00:00.100 - User A's request arrives first                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚ DB::beginTransaction()              â”‚                                 â”‚
â”‚  â”‚ $batch = Batch::lockForUpdate()    â”‚ â—„â”€â”€ LOCKED for User A           â”‚
â”‚  â”‚                                     â”‚                                 â”‚
â”‚  â”‚ Check: hasAvailableSlots(5)        â”‚                                 â”‚
â”‚  â”‚ â†’ TRUE (5 available)                â”‚                                 â”‚
â”‚  â”‚                                     â”‚                                 â”‚
â”‚  â”‚ Create booking...                   â”‚                                 â”‚
â”‚  â”‚ DB::commit()                        â”‚ â—„â”€â”€ Lock released               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                                                          â”‚
â”‚  Time: 10:00:00.150 - User B's request tries to lock                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚ DB::beginTransaction()              â”‚                                 â”‚
â”‚  â”‚ $batch = Batch::lockForUpdate()    â”‚ â—„â”€â”€ WAITS for User A            â”‚
â”‚  â”‚ ...waiting...                       â”‚                                 â”‚
â”‚  â”‚ ...User A commits...                â”‚                                 â”‚
â”‚  â”‚ ...Lock acquired!                   â”‚                                 â”‚
â”‚  â”‚                                     â”‚                                 â”‚
â”‚  â”‚ Check: hasAvailableSlots(5)        â”‚                                 â”‚
â”‚  â”‚ â†’ TRUE (0 available now!)           â”‚ â—„â”€â”€ User A took them            â”‚
â”‚  â”‚                                     â”‚                                 â”‚
â”‚  â”‚ âŒ Return error                     â”‚                                 â”‚
â”‚  â”‚ DB::rollBack()                      â”‚                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                                                          â”‚
â”‚  Result:                                                                â”‚
â”‚  âœ… User A: Booking successful (got last 5 slots)                       â”‚
â”‚  âŒ User B: Error "Only 0 slots available"                              â”‚
â”‚  âœ… NO OVERBOOKING!                                                     â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SUMMARY: Slot State Through The Journey                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  Initial State:                                                         â”‚
â”‚  Capacity: 50 â”‚ Slots Taken: 20 â”‚ Available: 30                         â”‚
â”‚                                                                          â”‚
â”‚  After User Creates Booking (Step 3):                                   â”‚
â”‚  Capacity: 50 â”‚ Slots Taken: 20 â”‚ Available: 30  â—„â”€â”€ No change         â”‚
â”‚  Booking Status: pending â³                                              â”‚
â”‚                                                                          â”‚
â”‚  After Payment Success (Step 6):                                        â”‚
â”‚  Capacity: 50 â”‚ Slots Taken: 30 â”‚ Available: 20  â—„â”€â”€ 10 reserved!      â”‚
â”‚  Booking Status: confirmed âœ…                                            â”‚
â”‚                                                                          â”‚
â”‚  If User Cancels:                                                       â”‚
â”‚  Capacity: 50 â”‚ Slots Taken: 20 â”‚ Available: 30  â—„â”€â”€ 10 released!      â”‚
â”‚  Booking Status: cancelled âŒ                                            â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ KEY DESIGN DECISIONS                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  1ï¸âƒ£  Why not reserve slots immediately at booking creation?              â”‚
â”‚     â†’ Prevents holding slots for users who abandon payment              â”‚
â”‚     â†’ Slots only locked after payment confirmation                      â”‚
â”‚     â†’ Maximizes availability for serious bookings                       â”‚
â”‚                                                                          â”‚
â”‚  2ï¸âƒ£  Why use database row locking?                                       â”‚
â”‚     â†’ Prevents race conditions with concurrent bookings                 â”‚
â”‚     â†’ Ensures atomic slot checking and reservation                      â”‚
â”‚     â†’ Eliminates overbooking risk                                       â”‚
â”‚                                                                          â”‚
â”‚  3ï¸âƒ£  Why suggest alternative dates?                                      â”‚
â”‚     â†’ Better user experience when preferred date is full                â”‚
â”‚     â†’ Increases conversion (user books different date)                  â”‚
â”‚     â†’ Reduces frustration and abandonment                               â”‚
â”‚                                                                          â”‚
â”‚  4ï¸âƒ£  Why track slots_taken instead of calculating from bookings?         â”‚
â”‚     â†’ Much faster queries (no need to sum bookings)                     â”‚
â”‚     â†’ Indexed field for performance                                     â”‚
â”‚     â†’ Simple, reliable slot counting                                    â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Quick Reference

### Formula
```
Available Slots = capacity - slots_taken
```

### Key Events
1. **Booking Created** â†’ Slots NOT reserved (status = pending)
2. **Payment Confirmed** â†’ Slots RESERVED (status = confirmed)
3. **Booking Cancelled** â†’ Slots RELEASED (status = cancelled)

### Protection Mechanisms
- âœ… Database row locking (prevents race conditions)
- âœ… Real-time validation (before booking creation)
- âœ… Atomic operations (increment/decrement)
- âœ… Transaction safety (rollback on error)

---

**Last Updated**: October 2, 2025
